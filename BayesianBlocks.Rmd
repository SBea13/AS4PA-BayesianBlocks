TO DO

- introduction about methods, few formulas
- algorithm presentation
- generate data, comparison with "normal" histogram
- application on spectrum
- (prior studies)
- (observation on high energy peak, try to fix that?)

```{r}

```

Import data

```{r}
data <- read.table("./Data/B19036_AmCsCo_20180316.dat", skip=2)

n     <- sum(data[,1])
start <- 0
stop  <- 8191
xs    <- c(start:stop)

block_length <- stop - c(start, 0.5*(xs[2:length(xs)]+xs[1:length(xs)-1]), stop);

options(repr.plot.width=12, repr.plot.height=7)  #to set graph size

plot(block_length[length(block_length):2], data[,1], type='s', log='y')

```

```{r}
library("pracma")
```

Prior

```{r}
ncp_prior <- 7.61

```

Algorithm

```{r}
# For data modes 1 and 2:
# nn_vec is the array of cell populations.
# Preliminary computation:

idx <- which(data[,1] >0)[1]
nn_vec <- data[,1][idx:length(data[,1])]

```

```{r}

```

```{r}
# ---------------------------------------------
# Start with first data cell; add one cell at
# each iteration
# ---------------------------------------------
best <- NULL 
last <- NULL
supp <- NULL

for (R in 1:8192){
# Compute fit_vec : fitness of putative last block (end at R)
    arg_log <- block_length[1:R] - block_length[R+1]
    arg_log[arg_log <= 0] <- Inf
    
    nn_cum_vec <- cumsum(nn_vec[R:1])
    nn_cum_vec <- nn_cum_vec[R:1]
    
    fit_vec <- nn_cum_vec * (log(nn_cum_vec) - log(arg_log))
    
    supp <- c(0, best) + fit_vec - ncp_prior

    best <- c(best, max(supp))
    last <- c(last, which.max(supp))
}    
```

```{r}
# #---------------------------------------------
# # Now find changepoints by iteratively peeling
# off the last block
# #---------------------------------------------
index <- last[length(nn_vec)]
change_points <- NULL

while (index > 1){
    change_points <- c(index, change_points)
    index <- last[index - 1]
}
change_points <- c(change_points, 8191)
```

```{r}
change_points
```

```{r}
#create histogram

rebin <- NULL
y <- NULL
n <- 1

for (i in 1:length(data[,1])){
    y <- y + data[i,1]
    ifelse( i %in% change_points,
           {y <- y/n
            rebin <- c(rebin, y)
            y <- 0
            n <- 1},
            n <- n+1
    )
}

```

```{r}
plot(block_length[length(block_length):2], data[,1], col= 'red', type='s', log='y')
lines(change_points, c(rebin, rebin[length(rebin)]), col='green', type='s')

#plot(change_points, c(rebin, rebin[length(rebin)]), col='green', type='s')

```

```{r}

```

```{r}

```

```{r}

```
